version: '3.8'

services:
  # LocalStack for AWS Secrets Manager emulation
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      SERVICES: secretsmanager
      DEBUG: 0
      EAGER_SERVICE_LOADING: 1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HashiCorp Vault in dev mode
  vault:
    image: hashicorp/vault:latest
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "test-root-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: server -dev -dev-root-token-id="test-root-token"

  # Initialize Vault with test data
  vault-init:
    image: hashicorp/vault:latest
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "test-root-token"
    entrypoint: /bin/sh
    command: |
      -c '
      # Enable KV v2 secrets engine
      vault secrets enable -path=secret kv-v2 || true
      
      # Create test secrets
      vault kv put secret/test-app/config \
        database_url="postgres://localhost:5432/testdb" \
        api_key="test-api-key-12345"
      
      vault kv put secret/test-app/nested/level1/config \
        nested_secret="nested-value"
      
      vault kv put secret/shared/common \
        shared_key="shared-value"
      
      echo "Vault initialized with test data"
      '
